name: Production Smoke Tests

on:
  push:
    tags: ['v*']
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  smoke:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tests/smoke/package-lock.json

      - name: Install smoke test dependencies
        run: npm ci
        working-directory: tests/smoke

      - name: Run smoke tests
        id: smoke
        run: npm run test:ci 2>&1 | tee smoke-output.txt
        working-directory: tests/smoke
        env:
          PROD_URL: ${{ secrets.PROD_URL }}

      - name: Create GitHub Issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let output = '';
            try {
              output = fs.readFileSync('tests/smoke/smoke-output.txt', 'utf8');
            } catch {}

            const unreachable = output.includes('SERVER UNREACHABLE');
            const suggestion = unreachable
              ? '**The server appears to be unreachable.** Check if the server needs redeployment.'
              : 'Check server logs for errors.';

            const body = [
              `## Smoke Test Failure`,
              ``,
              `**Time:** ${new Date().toISOString()}`,
              `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              ``,
              `### Suggestion`,
              suggestion,
              ``,
              `### Output (last 2000 chars)`,
              '```',
              output.slice(-2000),
              '```',
            ].join('\n');

            github.rest.issues.create({
              ...context.repo,
              title: `PROD ALERT: Smoke test failed â€” ${new Date().toISOString().slice(0, 19)}`,
              body,
              labels: ['prod-incident'],
            });

      - name: Send alert webhook on failure
        if: failure() && env.ALERT_WEBHOOK_URL != ''
        env:
          ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$ALERT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"ðŸš¨ Nexus prod smoke test FAILED â€” ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"}"
